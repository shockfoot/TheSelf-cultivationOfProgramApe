# 代码规范

## 编程规约

### 命名风格

1. **【强制】** 代码中的命名均不能以下划线或美元符号开始，也不能以下划线或美元符号结束。
2. **【强制】** 代码中的命名严禁使用拼音与英文混合的方式，更不允许直接使用中文的方式。正确的英文拼写和语法可以让阅读者易于理解，避免歧义。注意，尽可能使用英文命名方式，即使纯拼音命名方式也要避免采用。

> 国际通用的名称，如alibaba、taobao、youku、hangzhou，可视同英文。

4. **【强制】** 命名空间、类、结构体、枚举、委托的名称遵从`UpperCamelCase`（大驼峰式命名法）风格。其中，抽象类命名使用`Abstract`或`Base`开头；异常类命名使用`Exception`结尾；拓展类命名使用`Expand`结尾；测试类命名以它要测试的类的名称开始，以`Test`结尾；接口类命名使用大写`I`开头。
5. **【强制】** 方法名称统一遵从`UpperCamelCase`风格。
6. **【强制】** 形参、局部变量统一遵从`lowerCamelCase`（小驼峰式命名法）风格。
7. **【强制】** 私有/保护成员变量统一遵从`m_lowerCamelCase`风格，非私有/保护成员变量统一遵从`UpperCamelCase`风格。
8. **【强制】** 属性统一遵从`UpperCamelCase`风格。
9.  **【强制】** 类型参数统一遵从`TUpperCamelCase`风格。
10. **【推荐】** 常量命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，**不要嫌名字长**。
11. **【强制】** 杜绝完全不规范的缩写，避免望文不知义。
12. **【推荐】** 为了达到代码自解释的目标，任何自定义编程元素在命名时，使用尽量完整的单词组合来表达其意，**不要嫌名字长**。
13. **【推荐】** 如果模块、接口、类、方法使用了设计模式，在命名时需体现出具体模式，有利于阅读者快速理解架构设计理念。

``` csharp
正例：
public class OrderFactory;

public class LoginProxy;

public class ResourceObserver;

public interface IMove;
```

### 常量定义

1. **【强制】** 不允许任何未经预先定义的常量直接出现在常量的赋值中。

``` csharp
反例：
public Const string Key = "ID_" + tradeId;
```

2. **【推荐】** 不要使用一个常量类维护所有常量，要按常量功能进行归类，分开维护。

> 大而全的常量类，杂乱无章，使用查找功能才能定位到修改的常量，不利于理解和维护。

### 代码格式

1. **【参考】** 大括号的使用约定。如果是大括号内为空，则简洁地写成`{ }`即可，不需要换行；如果是非空代码块则`{`和`}`前、后都必须换行。
2. **【强制】** 左小括号和右小括号与括号中的字符之间不空格。在控制语句（`if`、`switch`、`for`、`foreach`、`while`、`do`、`try`、`catch`、`finally、``using`、`lock`、`fixed`）中的左小括号前需要空格。
3. **【强制】** 任何二目、三目运算符的左右两边都需要加一个空格（运算符包括赋值运算符=、逻辑运算符&&、加减乘除符号等）。
4. **【强制】** 采用4个空格缩进，禁止使用tab字符。如果使用tab缩进，必须设置1个tab为4个空格。

``` csharp
正例：
public static void main(String[] args) 
{
    string say = "hello";
    // 运算符的左右必须有一个空格
    int flag = 0;
    // 关键词 if 与括号之间必须有一个空格，括号内的 flag 与左括号，0 与右括号不需要空格
    if (flag == 0) 
    {
        Deubg.Log(say);
    }
    // 左大括号换行；左大括号后换行
    if (flag == 1)
    {
        Deubg.Log("world");
        // 右大括号前换行，右大括号后有 else，也要换行
    } 
    else
    {
        Deubg.Log("ok");
        // 在右大括号后直接结束，则必须换行
    }
}
```

5. **【强制】** 注释的双斜线与注释内容之间有且仅有一个空格。
6. **【强制】** 单行字符数限制不超过120个，超出需要换行，换行时遵循如下原则：
   1. 第二行相对第一行缩进4个空格，从第三行开始，不再继续缩进。
   2. 运算符与下文一起换行。
   3. 方法调用的点符号与下文一起换行。
   4. 方法调用中的多个参数需要换行时，在逗号后进行。
   5. 在括号前不要换行。

``` csharp
正例：
StringBuffer sb = new StringBuffer();
// 超过 140 个字符的情况下，换行缩进 4 个空格，点号和方法名称一起换行
sb.append("zi").append("xin")...
    .append("huang")...
    .append("huang")...
    .append("huang");

反例：
StringBuffer sb = new StringBuffer();
// 超过120个字符的情况下，不要在括号前换行
sb.append("zi").append("xin")...append 
    ("huang");
// 参数很多的方法调用可能超过120个字符，不要在逗号前换行
method(args1, args2, args3, ...
    , argsX);
```

7. **【强制】** 方法参数在定义和传入时，多个参数逗号后边必须加空格。
8. **【强制】** IDE的text file encoding设置为UTF-8；IDE中文件的换行符使用Unix格式，不要使用Windows格式。
9. **【推荐】** 单个方法的总行数不超过120行（包括方法签名、结束右大括号、方法内代码、注释、空行、回车及任何不可见字符的总行数）。
10. **【推荐】** 不同逻辑、不同语义、不同业务的代码之间插入一个空行分隔开来以提升可读性

### OOP规约

1. **【强制】** 避免通过一个类的对象引用访问此类的静态变量或静态方法，无谓增加编译器解析成本，直接用类名来访问即可。
2. **【强制】** 所有的重写方法，必须`override`关键字。
3. **【强制】** 相同参数类型，相同业务含义，使用确定的可变参数，避免使用`object`（尽量不用可变参数编程）。
4. **【强制】** `object`的`Equals`方法容易抛空指针异常，应使用常量或确定有值的对象来调用Equals。

``` csharp
正例：
"test".Equals(object); 

反例：
object.Equals("test");
```

5. **【强制】** 构造方法里面禁止加入任何业务逻辑，如果有初始化逻辑，请放在`Initial`方法中。
6. **【推荐】** 当一个类有多个构造方法或同名方法，这些方法应该按顺序放置在一起， 便于阅读。

### 集合处理

1. **【强制】** 关于`GetHashCode`和`Equals`的处理，遵循如下规则：
   1. 只要重写`Equals`，就必须重写`GetHashCode`。
   2. 如果自定义对象作为`Dictionary`的键，那么必须重写`GetHashCode`和`Equals`。
2. **【强制】** 在`foreach`场景中，高度注意对原集合元素的增加或删除，均会导致子列表的遍历、增加、删除产生`ConcurrentModificationException`异常。
3. **【强制】** 使用集合转数组的方法，必须使用集合的`ToArray()`，大小就是`list.Count`。
4. **【推荐】** 集合初始化时，指定集合初始值大小。

### 控制语句

1. **【强制】** 在一个`switch`块内，每个`case`要么通过`break/return`等来终止，要么注释说明程序将继续执行到哪一个`case`为止；**【推荐】** 在一个`switch`块内，都必须包含一个`default`语句并且放在最后，即使空代码。
2. **【强制】** 在`if`、`else`、`for`、`while`等语句中必须使用大括号。即使只有一行代码，避免采用单行的编码方式。
3. **【强制】** 在`if`语句中有异常流程需要直接`return`时，必须打印日志，用于出问题时查看日志定位问题。
4. **【强制】** 在使用`for`、`while`时，必须控制每一个分支，防止出现死循环。
5. **【推荐】** 表达异常的分支时，少用`else if`方式，这种方式可以改写成：

``` csharp
if (condition) {
    ...
    return obj;
}

// 接着写 else 的业务逻辑代码;
```

6. **【推荐】** 不要在条件判断中执行其它复杂的语句，将复杂逻辑判断的结果赋值给一个有意义的布尔变量名，以提高可读性。

``` csharp
反例：
if ((file.open(fileName, "w") != null) && (...) || (...)) 
{
    ...
}
```

7. **【推荐】** 避免采用取反逻辑运算符（取反逻辑不利于快速理解，并且取反逻辑写法必然存在对应的正向逻辑写法）。

### 注释规约

1. **【强制】** 类、类属性、类方法的注释，使用`<summary>`格式，不得使用`// xxx`方式。
2. **【强制】** 所有的类都必须添加创建者和创建日期。
3. **【强制】** 方法内部单行注释，在被注释语句上方另起一行，使用`//`注释。方法内部多行注释使用`/* */`注释，注意与代码对齐。
4. **【强制】** 所有的枚举类型字段必须要有注释，说明每个数据项的用途。
5. **【强制】** 对于版本兼容遗留的过期方法、接口、常量等，必须写上`// TODO`注释并标上`Obsolete`注解，提醒版本迭代时删除。
6. **【推荐】** 与其“半吊子”英文来注释，不如用中文注释把问题说清楚。专有名词与关键字保持英文原文即可。
7. **【推荐】** 代码修改的同时，注释也要进行相应的修改，尤其是参数、返回值、异常、核心逻辑等的修改。
8. **【参考】** 谨慎注释掉代码。在上方详细说明，而不是简单地注释掉。如果无用，则删除。
9. **【参考】** 对于注释的要求：第一、能够准确反应设计思想和代码逻辑；第二、能够描述业务含义，使别的程序员能够迅速了解到代码背后的信息。完全没有注释的大段代码对于阅读者形同天书，注释是给自己看的，即使隔很长时间，也能清晰理解当时的思路；注释也是给继任者看的，使其能够快速接替自己的工作。
10. **【参考】** 好的命名、代码结构是**自解释**的，注释力求精简准确、表达到位。避免出现注释的一个极端：过多过滥的注释，代码的逻辑一旦修改，修改注释是相当大的负担。
11. **【参考】** `// TODO`需要注明标记人与标记时间。以及需要处理的事项说明。

## 异常处理

1. **【强制】** 响应式可以注册`OnError`来监听异常，并处理异常。
2. **【强制】** 有预期的异常可以通过`if`判断来检查。
3. **【强制】** Android平台下可以使用`try-catch`来捕获异常。
4. **【强制】** `catch`时请分清稳定代码和非稳定代码，稳定代码指的是无论如何不会出错的代码。对于非稳定代码的`catch`尽可能进行区分异常类型，再做对应的异常处理。
5. **【强制】** 捕获异常是为了处理它，不要捕获了却什么都不处理而抛弃之，如果不想处理它，请将该异常抛给它的调用者。最外层的业务使用者，必须处理异常，将其转化为用户可以理解的内容。
6. **【强制】** `finally`块必须对资源对象、流对象进行关闭，有异常也要做`try-catch`。
7. **【强制】** 不要在`finally`块中使用`return`。
8. **【强制】** 捕获异常与抛异常，必须是完全匹配，或者捕获异常是抛异常的父类。
9. **【推荐】** 方法的返回值可以为`null`，不强制返回空集合，或者空对象等，必须添加注释充分说明什么情况下会返回`null`值。

## 功能测试

1. **【强制】** 全新功能建立之前需要根据设计需求，罗列开发的功能点。也是完成之后自测的用例。
2. **【强制】** 根据功能点需要编写类图，流程图，如果有需要，还需要编写数据流通生命周期相关的示意图。
3. **【强制】** 如功能模块是基础组件模块，或者有较强通用性和适用性，需要确实保证运行稳定再提交。
4. **【强制】** 如功能开发周期较长，需在开发期间做一个或多个检查节点。例如开发需要3周，那么在每周结束的时候可以做一个检查节点，保证开发质量和周期与预期相符。
5. **【强制】** 代码提交前编译通过、自测通过。
6. **【推荐】** 自测时可以测试多种环境，以便测试代码的稳定性和适用性。包含但不限于各种临界条件，玩家可能的真实存在的异常操作，不同平台不同品牌不同设备下的适配等。